\documentclass[a4paper,12pt]{article}
%\documentclass[11pt,twoside,a4paper]{book}
\usepackage{float}
\usepackage{graphicx} %pacote pra colocar imagem
\graphicspath{ {images/} }
\usepackage[utf8]{inputenc}
\usepackage[brazil]{babel}
% \usepackage{cite}

 \usepackage{setspace}                   % espa√ßamento flex√≠vel
 \usepackage{indentfirst}                % indenta√ß√£o do primeiro par√°grafo
 \usepackage[fixlanguage]{babelbib}
 \usepackage[font=small,format=plain,labelfont=bf,up,textfont=it,up]{caption}
 \usepackage[usenames,svgnames,dvipsnames]{xcolor}
%  \usepackage[a4paper,top=2.54cm,bottom=2.0cm,left=2.0cm,right=2.54cm]{geometry} % margens
 \usepackage{amsmath,amssymb,exscale}

%  \usepackage[pdftex]{hyperref}
 \usepackage[pdftex,plainpages=false,pdfpagelabels,pagebackref,colorlinks=true,citecolor=DarkGreen,linkcolor=NavyBlue,urlcolor=DarkRed,filecolor=green,bookmarksopen=true]{hyperref} % links coloridos
 \usepackage[all]{hypcap}                    % soluciona o problema com o hyperref e capitulos
 \usepackage[round,sort,nonamebreak]{natbib} % cita√ß√£o bibliogr√°fica textual(plainnat-ime.bst)
 \bibpunct{[}{]}{;}{n}{\hspace{-0.7ex},}{,} % estilo de cita√ß√£o. Veja alguns exemplos em http://merkel.zoneo.net/Latex/natbib.php

 \usepackage{pdfpages}

%  \fontsize{60}{62}\usefont{OT1}{cmr}{m}{n}{\selectfont}

 \usepackage{listings}
 \usepackage{fancyvrb}

\title{Trabalho de Conclus√£o de Curso}
\author{Guilherme Freire Silva}
\date{\today}

% ---------------------------------------------------------------------------- %
% INFORMA√á√ïES

\pdfinfo{%
  /Title    (Comunica√ß√£o cliente-servidor bilateral de baixa lat√™ncia aplicado a Android)
  /Author   (Guilherme Freire Silva)
  /Subject  (Trabalho de Conclus√£o de Curso)
  /Keywords (TCC, Lean UX)
}

\begin{document}
\pagenumbering{gobble}
% ---------------------------------------------------------------------------- %
% CAPA
% Nota: O t√≠tulo para as disserta√ß√µes/teses do IME-USP devem caber em um
% orif√≠cio de 10,7cm de largura x 6,0cm de altura que h√° na capa fornecida pela SPG.

\thispagestyle{empty}
\begin{center}
    \vspace*{2.3cm}
    \textbf{\Large{Comunica√ß√£o cliente-servidor bilateral de baixa lat√™ncia aplicado a Android}}\\


    \vspace*{1.2cm}
    \Large{
        Guilherme Freire Silva
    }
    \vskip 2cm
    \textsc{
     Trabalho de Conclus√£o de Curso \\[-0.25cm]
    Instituto de Matem√°tica e Estat√≠stica\\[-0.25cm]
    da\\[-0.25cm]
    Universidade de S√£o Paulo\\[-0.25cm]%}
    }

    \vskip 2.5cm
    Orientador: Prof. Dr. Marco Dimas Gubitoso

    \vskip 3.5cm
    \normalsize{S√£o Paulo, 2016}
\end{center}

\newpage
% \include{secoes/quote}

\newpage
\listoffigures
\listoftables
\tableofcontents

% \include{secoes/resumo}

\newpage %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\pagenumbering{arabic}     % come√ßamos a numerar

\renewcommand{\arraystretch}{1.2}

% \include{secoes/introducao}
% \include{secoes/metodologias/ux}
% \include{secoes/metodologias/lean}
% \include{secoes/metodologias/agile}
% \include{secoes/metodologias/lean_ux}
% \include{secoes/desenvolvimento/processos_lean}
% \include{secoes/desenvolvimento/processos_app}
% %\include{secoes/analiseSubjetiva}
% \include{secoes/apendice/apendice}

%\section{An√°lise Subjetiva}
\addcontentsline{toc}{section}{Refer√™ncias}

\newpage
\section{Resumo}


\newpage
\section{Abstract}


\newpage
\section{Introdu√ß√£o}
% \alert{semper massa}
Dispositivos m√≥veis, como smartphones e tablets, est√£o cada dia mais presentes. Sua tecnologia se atualiza a cada momento e ainda √© muito nova, muitas de suas funcionalidades ainda podem ser bastante exploradas.

O mesmo vale para tecnologias para a internet. O ambiente Web est√° em constante transforma√ß√£o, APIs \footnote{\emph{Application Programming Interface}, conjunto de rotinas e padr√µes de programa√ß√£o para acesso a um aplicativo de software ou plataforma baseado na Web} e ferramentas s√£o criadas e renovadas a todo momento e podem ser aplicadas a v√°rios contextos de forma relevante e inovadora.

Com esse contexto em mente, o Projeto apresentado foi concebido para unir essas duas pontas de tecnologias em uma Aplica√ß√£o Web que se comunica com um dispositivo m√≥vel. O conceito b√°sico √© ter um Applicativo de smartphone que se conecte a um servidor e passe a enviar e receber informa√ß√µes. O servidor lan√ßa uma p√°gina Web que recebe esses dados enviados e execute sua funcionalidade.

O conceito de ‚Äúfuncionalidade" √© propositalmente deixado em aberto pois esse fluxo de dados encapsula uma grande variedade de funcionalidades. √â poss√≠vel, por exemplo, executar um jogo na p√°gina Web que utiliza o smartphone como um controle, ou manter um banco de dados no Servidor e fazer buscas utilizando o smartphone. Estes exemplos e outros s√£o aprofundados na se√ß√£o de Casos de Uso (TODO se√ß√£o de Casos de Uso).

O Projeto tem como objetivo ent√£o abrir e esse canal de comunica√ß√£o bilateral entre p√°ginas Web e smartphones, al√©m de facilitar o desenvolvimento de aplica√ß√µes voltadas a essa estrutura.


% \newpage
% \subsection{Motiva√ß√£o}

% Precisa de uma? (TODO)

\newpage
\subsection{Objetivos}

- Desenvolver um aplicativo para smartphones.

- Criar um servidor.

- Construir uma comunica√ß√£o entre ambos.

- Encontrar uma forma eficiente de comunica√ß√£o.

- Desenvolver uma p√°gina Web como Caso de Uso.



\newpage
\section{Desenvolvimento}

Nessa se√ß√£o, √© apresentado o que implementa o Projeto. O c√≥digo ser√° exibido e explicado, al√©m das tecnologias necess√°rias.


\subsection{Comunica√ß√£o}

A comunica√ß√£o √© a parte mais importante deste Projeto. O modelo cliente-servidor(TODO ref) foi usado, mas foi necess√°rio levar alguns pontos em considera√ß√£o. O cliente de smartphone e o cliente Web precisam se comunicar com o servidor da melhor forma poss√≠vel. O protocolo de comunica√ß√£o √© o fator que mais pode limitar as possibilidades previstas. Para n√£o haver problemas, a comunica√ß√£o precisa de:

- Baixa lat√™ncia. No caso de o cliente Web executar um jogo, o tempo entre um comando enviado do smartphone e a rea√ß√£o da p√°gina precisa ser o menor poss√≠vel. Caso contr√°rio a experi√™ncia √© danificada e pode at√© ser impossibilitada, se o jogo for constru√≠do com base em respostas r√°pidas.

- Cabe√ßalho m√≠nimo de mensagens. Se o fluxo de mensagens for alto, esse cabe√ßalho pode consumir muita banda da conex√£o, al√©m de exigir muitos recursos, tanto do servidor como dos clientes. √â necess√°rio que ele possua a menor quantidade de informa√ß√µes desnecess√°rias. Caso a mensagem tenha muito conte√∫do, ele far√° pouca diferen√ßa, mas se ela for pequena, como um texto ou um conjunto de valores, o cabe√ßalho representa um aumento significativo no tamanho total, podendo ser at√© maior do que o pr√≥prio conte√∫do.

- Conex√£o bilateral. Informa√ß√µes podem se originar de qualquer um dos clientes ou do servidor, ent√£o √© necess√°rio que o processo em quest√£o possa enviar as informa√ß√µes a qualquer momento. No caso de um cliente precisar ser atualizado caso haja dados novos, √© invi√°vel que precise consultar o servidor a todo momento.

- Permitir multiplas conex√µes simult√¢neas. N√£o √© necess√°rio, mas permite uma liberdade ainda maior. √â previsto somente que o servidor se conecte a um cliente Web e de smartphone, mas, se o servidor aceitar a conex√£o com v√°rios clientes do mesmo tipo, o desenvolvimento deles pode tirar proveito disso. Um smartphone pode enviar e receber informa√ß√µes de outros, como em um Chat, por exemplo.

Com esses requerimentos em vista, o tecnologia usada foi o Framework de JavaScript Socket.io, que implementa o protocolo WebSocket.


\subsubsection{Protocolo WebSocket}

% https://www.websocket.org/aboutwebsocket.html

WebSocket √© um protocolo que lida com Sockets (TODO ref) de uma conex√£o que foi criado para permitir a comunica√ß√£o bilateral entre cliente e servidor. Ele permite mais liberdade para criar novos protocolos e maneiras de se transferir dados.

Sua interface √© bastante simples, seu objetivo √© o envio e recebimento de mensagens entre o cliente e o servidor. Para o protocolo, n√£o existe essa diferencia√ß√£o entre os dois, ambos s√£o apenas dois processos conectados. Essa hierarquia cliente-servidor deixa de existir e n√£o h√° mais uma separa√ß√£o de fun√ß√µes entre ambos. A comunica√ß√£o √© dada por envio de mensagens e ocorr√™ncia de eventos. Esses processos podem enviar mensagens a qualquer momento e est√£o ouvindo um ao outro.

O protocolo foi pensado para funcionar bem com a infraestrutura Web j√° existente. Como parte desse paradigma, sua especifica√ß√£o determina que uma conex√£o √© estabelecida inicialmente com o protocolo HTTP (TODO ref), garantindo retrocompatibilidade.

A conex√£o √© feita da seguinte forma. Ap√≥s inciada a conex√£o HTTP, o cliente envia uma requisi√ß√£o ao servidor indicando que deseja trocar de protocolos, de HTTP para WebSocket. Se o servidor entende esse protocolo, ele envia uma resposta para permitir a troca. Nesse momento a conex√£o HTTP √© interrompida e a conex√£o WebSocket toma o seu lugar. Esse processo √© chamado de {WebSocket Handshake} (TODO form).

A estrutura da mensagem em WebSocket √© m√≠nima. O corpo da mensagem, os dados a serem enviados, s√≥ possui dois formatos, texto ou bin√°rio. O cabe√ßalho cont√©m um identificador de tipo do formato, que tem um campo para o tamanho da mensagem e nada mais. A mensagem completa √© s√≥ o conte√∫do mais seu tamanho. Como a conex√£o n√£o muda em momento algum, todas as informa√ß√µes contidas no cabe√ßalho de requisi√ß√£o e resposta HTTP s√£o invariantes e, portanto, n√£o precisam ser reenviadas.

Um dos processos conectados, em um momento arbitr√°rio, envia uma mensagem ao outro, talvez porque dados tenham sido atualizados ou o usu√°rio tenha feito alguma a√ß√£o em espec√≠fico. Uma vez que a mensagem √© enviada, esse processo volta ao que estava fazendo, sem a necessidade de esperar uma resposta (com a exce√ß√£o talvez de qualquer confirma√ß√£o sobre a entrega). Esse comportamento √© chamado de ass√≠ncrono, pois n√£o necessita de uma resposta para continuar com sua execu√ß√£o.

O outro processo v√™ a chegada dessa nova mensagem como um evento. Quando esse evento acontece, ele executa um comportamento espec√≠fico (\emph{callback}) com os dados recebidos, como altera√ß√£o de informa√ß√µes exibidos ou um c√°lculo com os valores novos. Por isso √© dito que Websocket √© orientado a eventos.

%(TODO bulletpoints)
Existem quatro tipos de eventos e seus \emph{callbacks} s√£o definidos na cria√ß√£o do WebSocket. Esses eventos s√£o:

- \emph{onopen}: ocorre quando a conex√£o √© feita;

- \emph{onclose}: ocorre quando a conex√£o √© fechada;

- \emph{onmessage}: ocorre quando uma mensagem do outro WebSocket chega;

- \emph{onerror}: ocorre se h√° algum erro na conex√£o.

% (TODO linkar exemplo)

\subsubsection{Socket.io}

Socket.io √© a API de WebSocket para JavaScript utilizada. Ele cuida de todos os detalhes de funcionamento do protocolo internamente, deixando uma interface simples ao usu√°rio.

Para uma conex√£o ser estabelecida, tanto o cliente quanto o servidor precisam estar executando Socket.io. Sua implementa√ß√£o tenta primeiramente fazer a conex√£o usando WebSocket, mas se o servidor n√£o suporta esse protocolo, ele recua (faz \emph{fallback}) para outras tecnologias, como \emph{AJAX long-polling}, \emph{AJAX multipart streaming}, \emph{IFrame}, \emph{JSONP polling}, entre outros (todos utilizando a mesma interface). Esse \emph{fallback} abrange uma quantidade muito maior de servidores, permitindo um uso n√£o t√£o restrito dessa API.

Al√©m da implementa√ß√£o b√°sica do protocolo WebSocket, ele tamb√©m adiciona outras funcionalidades muito importantes para o desenvolvimento de uma aplica√ß√£o maior e mais robusta. As que foram utilizadas no Projeto foram:


- √â poss√≠vel conectar m√∫ltiplos sockets em uma mesma porta. Internamente, ele faz uma multiplexa√ß√£o das v√°rias conex√µes abertas em uma mesma porta, mas os processos entendem que tem um socket dedicado a eles. Utilizando WebSockets, cada socket precisa de uma porta exclusiva para fazer a conex√£o.

A possibilidade de v√°rios sockets em uma mesma aplica√ß√£o permite uma modulariza√ß√£o muito maior, pois n√£o √© necess√°rio que um m√≥dulo saiba se tem uma conex√£o dedicada ou se est√° compartilhando com mais dezenas de outros sockets.

- Ele permite a cria√ß√£o arbritr√°ria de eventos. Com WebSocket, o desenvolvedor fica preso aos quatro eventos pr√© definidos: onopen, onclose, onmessage e onerror. Internamente, os quatro s√£o eventos de mensagem, disparados em momentos e situa√ß√µes espec√≠ficas. O que o Socket.io faz √© dar a liberdade de definir quaisquer eventos desejados.

Essa cria√ß√£o de eventos funciona assim: na hora de enviar uma mensagem, o processo emissor define tamb√©m o nome do evento que est√° sendo enviado. O processo receptor define o evento que vai ouvir e a subrotina que vai ser executada na ocorr√™ncia desse evento.

Um ponto negativo dessa defini√ß√£o de eventos √© que o cabe√ßalho da mensagem √© um pouco maior, pois o de WebSockets √© m√≠nimo ao extremo, mas esse tamanho ainda √© √≠nfimo e o overhead causado √© desprez√≠vel.

Essas funcionalidades aumentam o grau de liberdade e permitem um escopo maior na hora de criar uma aplica√ß√£o robusta. %Imagine um sistema grande, onde dados s√£o recebidos de m√∫ltiplas fontes, c√°lculos s√£o feitos sobre eles, e o resultado pode ativar v√°rios comportamentos de um outro processo. Algo assim exigiria um c√≥digo complexo com WebSockets, mas com Socket.io √© simples e direto.

Exemplos de uso de Socket.io est√£o presentes no pr√≥prio c√≥digo do servidor e dos clientes implementados.



\subsection{Aplicativo Android}

O aplicativo foi desenvolvido com a proposta de servir como base para o desenvolvimento de aplicativos maiores. Ele possui os elementos b√°sicos definidos na proposta desse Projeto. Ele foi implementado usando o \emph{framework} Cordova.

\subsubsection{Cordova}

O Apache Cordova √© um \emph{framework} \emph{open-source} para a cria√ß√£o de aplicativos para \emph{mobile}. Seu desenvolvimento √© dado com o uso de tecnologias Web, como HTML5, CSS3 e JavaScript.

Ele √© multiplataforma, permite o desenvolvimento para sistemas como Android, iOS ou navegadores. Oferece uma API de alto n√≠vel para acessar os m√≥dulos desejados, como de sensores, arquivos e rede.

O aplicativo implementado √© uma p√°gina Web, possui exatamente a estrutura. H√° um arquivo principal ‚Äúindex.html" que referencia os recursos necess√°rios, como CSS, JavaScript, imagens e arquivos de m√≠dia. A parte l√≥gica √© feita em JavaScript, e a renderiza√ß√£o em HTML5 e CSS3. Para ser portado para uma plataforma espec√≠fica, o HTML √© enviado para a classe \emph{‚ÄúWrapper‚Äù} dessa plataforma, onde est√£o definidos os detalhes de implementa√ß√£o. Essa classe tamb√©m tem incorporada um browser nativo, o \emph{WebView}, que executar√° o programa Web dentro do dispositivo.

\subsubsection{Implementa√ß√£o}

O aplicativo implementado possui o b√°sico de intera√ß√£o, ele conecta-se com o servidor, exibe informa√ß√µes recebidas na tela, utiliza alguns bot√µes para mandar informa√ß√µes e faz o uso do aceler√¥metro do dispositivo.

Essa √© uma imagem de sua interface:

% TODO SS do aplicativo

As intera√ß√µes da interace s√£o: % TODO verificar se n√£o mudou nada

- Um formul√°rio para fazer a conex√£o com o servidor, dados IP e porta. H√° um feedback visual que indica se ela foi bem sucedida.

- Um campo ‚ÄúLog" que exibe o resultado de algumas intera√ß√µes do usu√°rio, ou mensagens enviadas do servidor.

- Um conjunto de bot√µes que emitem a√ß√µes pontuais ao servidor, como calcular o \emph{Ping} \footnote{tempo necess√°rio para uma mensagem ser enviada ao servidor e voltar dele} ou enviar um conjunto de dados.

- Um outro conjunto de bot√µes que ligam ou desligam um fluxo cont√≠nuo de mensagens. Essas mensagens emitidas cont√™m os dados do aceler√¥metro do aparelho.

Essas funcionalidades implementadas j√° cobrem muitas intera√ß√µes desejadas no desenvolvimento de qualquer tipo de aplicativo.


\subsubsection{C√≥digo da Interface}
A parte visual do aplicativo est√° no arquivo index.html:

%(TODO MyTest/index.html here)

- A divis√£o ‚Äúdeviceready" (TODO linha X) exibe o estado da conex√£o.

> Caso o dispositivo n√£o tenha se conectado ainda, ele exibe ‚ÄúConnect Device".

> Ao obter uma conex√£o bem sucessida com o servidor, ele muda para ‚ÄúDevice is Connected".


- O formul√°rio ‚Äúconnect" (TODO: linha X) faz a conex√£o do dispositivo com o servidor.

> Ele possui um campo para o IP e um para a Porta do servidor.

> Ao apertar o bot√£o ‚ÄúConnect", ele tenta fazer a conex√£o.


- O par√°grafo ‚Äúlog" (TODO linha X) exibe dados vindos do servidor.

- Os bot√µes(TODO linha X a Y) executam diversas fun√ß√µes do c√≥digo de enviar atrav√©s de eventos para o servidor.

- Os scripts (TODO linha X a Y) importam as bibliotecas cordova, jquery e socket.io, e a parte l√≥gica do aplicativo, encontrado em ‚Äújs/index.js".


\subsubsection{C√≥digo da parte l√≥gica}

A parte l√≥gica do aplicativo est√° no arquivo index.html:

%(TODO MyTest/index.html here)


Para inicializar o aplicativo:

A vari√°vel ‚Äúapp" (TODO linha X) √© uma classe padr√£o do Cordova com fun√ß√µes para inicializar o aplicativo. Ele √© inicializado na linha X (TODO).


Para fazer a conex√£o com o servidor:

Na linha X (TODO), uma fun√ß√£o √© adicionada ao evento ‚Äúdeviceready" que o Cordova emite quando tudo acaba de ser inicializado. Quando o evento ocorre, a a√ß√£o do bot√£o ‚ÄúConnect" √© alterada para tentar conectar-se ao servidor, atrav√©s da fun√ß√£o ‚ÄúconnectSocket".

Essa fun√ß√£o connectSocket recebe o IP e Porta vindos do formul√°rio do bot√£o. Se o IP for v√°lido (a fun√ß√£o ‚ÄúvalidateIPaddress" faz essa verifica√ß√£o com expres√µes regulares), ela fazer uma conex√£o entre o dispositivo e o servidor definido por esses IP e porta. Se a conex√£o j√° est√° feita, ele a disconecta.


Eventos que o servidor ativa:

Na inicializa√ß√£o do Socket, dois eventos s√£o definidos, ‚Äúconnect", que chama a fun√ß√£o ‚ÄúonServerConnect" e ‚Äúserver\_ping", que chama ‚ÄúonServerPing".

‚ÄúonServerConnect" emite ao socket um evento ‚Äúready" para o servidor para informar o seu tipo e atualiza informa√ß√µes exibidas.

‚ÄúonServerPing" calcula o ping que foi enviado.


Eventos enviados ao servidor:

As fun√ß√µes ‚ÄúaddSpeed", ‚ÄúresetSpeed", ‚ÄúsendAcceleration", ‚ÄúsendPing" e ‚ÄúlocalCalculation" enviam mensagens ao servidor com dados obtidos do input do usu√°rio ou leitura do smartphone.

A fun√ß√£o ‚ÄútoggleAccelerometer" ativa um loop que manda leituras do aceler√¥metro em intervalos regulares.




\subsection{Aplica√ß√£o Web como Caso de Uso}

A Aplica√ß√£o Web criada para exemplificar o uso do sistema proposto pelo Projeto foi projetada com a ideia de servir de base para o desenvolvimento de um jogo.

A primeira decis√£o de design foi fazer o \emph{browser} executar uma computa√ß√£o gr√°fica. Para tal, foi utilizada a biblioteca THREE.JS.


\subsubsection{THREE.JS}
% https://en.wikipedia.org/wiki/WebGL

% https://en.wikipedia.org/wiki/Three.js
% https://www.npmjs.com/package/three

THREE.JS √© uma biblioteca de JavaScript para a cria√ß√£o e execu√ß√£o de gr√°ficos 3D em navegadores, de maneira leve e otimizada. Ele permite ao \emph{browser} renderizar gr√°ficos sem a necessidade de plugins, e utilizar a GPU(TODO explicar GPU) do usu√°rio para os c√°lculos de f√≠sica e processamento de imagens. Essas funcionalidades s√£o herdadas de WebGL, uma outra API de computa√ß√£o gr√°fica em JavaScript para \emph{browsers}.

Sua interface √© simples de se usar, ela lida internamente com os detalhes t√©cnicos de implementa√ß√£o de baixo n√≠vel, deixando o desenvolvimento menos carregado, uma vez que processamento gr√°fico √© uma √°rea complexa da computa√ß√£o.

THREE.JS √© completa o bastante para a cria√ß√£o de cen√°rios 3D completos, com objetos, luzes e texturas. Por utilizar a GPU para o processamento, a performance n√£o √© comprometida por suas funcionalidades.

Abaixo est√° uma lista de funcionalidades que possui. Por possuir muitos termos ingl√™s sem tradu√ß√£o em portugu√™s, a lista de forma literal da sua p√°gina na Wikip√©dia:
% https://en.wikipedia.org/wiki/Three.js

% TODO list
Three.js includes the following features:

- Effects: Anaglyph, cross-eyed and parallax barrier.

- Scenes: add and remove objects at run-time; fog

- Cameras: perspective and orthographic; controllers: trackball, FPS, path and more

- Animation: armatures, forward kinematics, inverse kinematics, morph and keyframe

- Lights: ambient, direction, point and spot lights; shadows: cast and receive

- Materials: Lambert, Phong, smooth shading, textures and more

- Shaders: access to full OpenGL Shading Language (GLSL) capabilities: lens flare, depth pass and extensive post-processing library

- Objects: meshes, particles, sprites, lines, ribbons, bones and more - all with Level of detail

- Geometry: plane, cube, sphere, torus, 3D text and more; modifiers: lathe, extrude and tube

- Data loaders: binary, image, JSON and scene

- Utilities: full set of time and 3D math functions including frustum, matrix, quaternion, UVs and more

- Export and import: utilities to create Three.js-compatible JSON files from within: Blender, openCTM, FBX, Max, and OBJ

- Support: API documentation is under construction, public forum and wiki in full operation

- Examples: Over 150 files of coding examples plus fonts, models, textures, sounds and other support files

- Debugging: Stats.js, WebGL Inspector, Three.js Inspector



\subsubsection{Implementa√ß√£o}

Esse projeto explora somente o b√°sico de THREE.js para a cria√ß√£o de um ambiente 3D.

√â criada uma esfera no  centro da tela que recebe valores de \emph{devices} vindos do servidor. Esses valores podem mudar a velocidade de rota√ß√£o nos eixos X, Y e Z, e a sua cor.

Este c√≥digo √© mais extenso, ent√£o algumas partes ser√£o omitidas.

O primeiro arquivo, global.js, declara vari√°veis globais, usadas em mais de um m√≥dulo:


\begin{small}
\begin{Verbatim}[frame=single]
var socket;

var xRot, yRot, zRot;
var r, g, b;
var hasNewColors;
\end{Verbatim}
\end{small}

As vari√°veis declaradas definem o seguinte:

- O socket da conex√£o;

- As velocidades de rota√ß√£o xRot, yRot e zRot;

- A cor RGB da esfera;

- Uma \emph{flag} que aponta se a cor precisa ser atualizada.


O arquivo socket\_events.js, define os eventos escutados e seus \emph{callbacks}:

\begin{small}
\begin{Verbatim}[frame=single]
socket = io();

function rotate (data) {
    xRot += data.x;
    yRot += data.y;
    zRot += data.z;
}

function reset_rotation () {
    xRot = 0;
    yRot = 0;
    zRot = 0;
}

function update_rotation_and_colors (data) {
    var cap = 9;
    var x = Math.min(data.x, cap);
    var y = Math.min(data.y, cap);
    var z = Math.max(2, Math.min(data.z, cap));

    var weight = 5;

    xRot = y / 50;
    yRot = x / 50;

    r = (weight * r + (z / cap)) / (weight + 1);
    g = (weight * g + (z / cap)) / (weight + 1);
    b = (weight * b + (z / cap)) / (weight + 1);

    hasNewColors = true;
}

// Socket Events

socket.on('connect', function() {
    socket.emit('ready', 'browser');
});

socket.on('move', function (data) {
    rotate(data);
});

socket.on('reset', function () {
    reset_rotation();
});

socket.on('update_acceleration', function (data) {
    update_rotation_and_colors(data);
})
\end{Verbatim}
\end{small}

H√° 4 eventos de Sockets:

- \emph{'connect'}: Ao se conectar, emite um evento \emph{'ready'} com seu tipo.

- \emph{'move'}: Recebe valores X, Y e Z, e os associa √† velocidade de rota√ß√£o da esfera em cada um desses eixos. Essa associa√ß√£o √© incremental, a velocidade aumenta a cada evento.

- \emph{'reset'}: Zera as velocidades de rota√ß√£o da esfera.

- \emph{'update\_acceleration'}: Recebe valores X, Y, Z que definem a velocidade de rota√ß√£o total da esfera (n√£o incremental). Tamb√©m altera sua cor incrementalmente, de acordo com alguns c√°lculos com as vari√°veis.


Por fim, o arquivo three\_sphere.js cria cria todos os elementos gr√°ficos e os renderiza.

\begin{small}
\begin{Verbatim}[frame=single]

var scene, camera, renderer;
var sphere, sphere;

hasNewColors = false;

function updateSphereRotation(xRot, yRot, zRot) {
    sphere.rotation.x += xRot;
    sphere.rotation.y += yRot;
    sphere.rotation.z += zRot;
}

function updateSphereColor(r, g, b) {
    sphere.material.color.r = r;
    sphere.material.color.g = g;
    sphere.material.color.b = b;
}


function init() {

    scene = new THREE.Scene();

    var view_angle = window.innerWidth/window.innerHeight
    camera = new THREE.PerspectiveCamera( 75, view_angle, 0.1, 1000 );
    camera.position.z = 5;
    scene.add(camera);

    renderer = new THREE.WebGLRenderer();
    renderer.setSize( window.innerWidth, window.innerHeight );
    document.body.appendChild( renderer.domElement );

    //-------------------------------------------

    // create a point light
    var pointLight = new THREE.PointLight(0xFFFFFF);

    // set its position
    pointLight.position.x = 10;
    pointLight.position.y = 50;
    pointLight.position.z = 130;

    // add to the scene
    scene.add(pointLight);

    //-------------------------------------------

    // New Sphere
    var radius = 2;
    var segments = 16;
    var rings = 16;

    var sphereGeo = new THREE.SphereGeometry(radius, segments, rings);
    var sphereMaterial = new THREE.MeshLambertMaterial( {
        color: 0xCC0000,
        wireframe : true
    } );
    sphere = new THREE.Mesh( sphereGeo, sphereMaterial );
    scene.add( sphere );

    //-------------------------------------------

    xRot = 0;
    yRot = 0;
    zRot = 0;

    r = 1;
    g = 1;
    b = 0;
}

function render() {
    requestAnimationFrame( render );

    updateSphereRotation(xRot, yRot, zRot);
    if (hasNewColors) {
        updateSphereColor(r, g, b);
        hasNewColors = false;
    };

    renderer.render(scene, camera);
};

init();
render();
\end{Verbatim}
\end{small}

- init() cria os elementos do cen√°rio: a cena, a camera, o renderizador, a ilumina√ß√£o e a esfera, al√©m de inicializar as vari√°veis.

- render() atualiza a posi√ß√£o da esfera de acordo com sua velocidade (com updateSphereRotation()), sua cor (com updateSphereColor()), caso haja mudan√ßas, e renderiza a cena. Essa fun√ß√£o √© chamada a cada \emph{frame}, o que garante que a esfera seja animada.



\newpage
\subsection{Servidor}

O servidor √© implementado com Javascript, com o auxilio de Node.js e ExpressJS

\subsubsection{Node.js e ExpressJS para criar um servidor}
% https://www.youtube.com/watch?v=pU9Q6oiQNd0
% https://nodejs.org/en/
% https://www.tutorialspoint.com//nodejs/nodejs_introduction.htm

% http://tableless.com.br/o-que-nodejs-primeiros-passos-com-node-js/
Node.js √© uma plataforma para desenvolvimento de aplica√ß√µes \emph{server-side} (executadas no servidor) baseadas em rede utilizando JavaScript e o V8 JavaScript Engine \footnote{√â o interpretador de JavaScript \emph{open source} implementado pelo Google em C++ e utilizado pelo Chrome.}. Com Node.js √© poss√≠vel criar aplica√ß√µes Web utilizando apenas c√≥digo em JavaScript.

Ao se levar em conta o modo em que o c√≥digo em JavaScript pode ser estruturado e as demandas de aplica√ß√µes Web, Node.js abre uma gama de novas possibilidades para desenvolvimento Web.


% http://www.tutorialspoint.com/expressjs/index.htm
Express √© um \emph{framework} m√≠nimo e flex√≠vel para Node.js que oferece um conjunto robusto de funcionalidades. Sua API √© simples, mas oferece o conjunto de ferramentas essenciais para o desenvolvimento de para p√°ginas e aplica√ß√µes Web e Mobile, e programas \emph{backend}. Ela lida com detalhes de baixo n√≠vel como protocolos e processos. Al√©m da sua funcionalidade b√°sica, existem m√≥dulos dispon√≠veis para adicionar novas funcionalidades, que s√£o diretamente aplicados ao Express.

Para essa implementa√ß√£o, Node.js e Express trabalham em conjunto para criar um servidor local e criar a p√°gina da Aplica√ß√£o Web desenvolvida.

\subsubsection{Implementa√ß√£o}

O servidor criado para o Projeto tem suas configura√ß√µes definidas no arquivo package.json. Esse arquivo permite a restaura√ß√£o e reprodu√ß√£o do servidor em outros locais.

%(TODO package.json here)

A configura√ß√£o mais importante para a reprodu√ß√£o √© a de dependencias, na qual est√£o definidas ‚Äúexpress" e ‚Äúsocket.io".

Para a leitura do c√≥digo, √© importante ter em mente que o servidor faz uma distin√ß√£o entre sockets de \emph{browser}, que executam a aplica√ß√£o Web, e sockets de \emph{device}, que executam o aplicativo do Cordova.

O c√≥digo que cria o servidor est√° em index.js:

%(TODO index.js here)


O servidor √© criado utiliznado o ExpressJS, ouvindo na porta definida e utilizando recursos encontrados na pasta ‚Äú/public"

Quando uma conex√£o √© iniciada, o socket criado √© atribu√≠do de eventos e seus respectivos \emph{callbacks}. Os eventos s√£o:

\emph{ready}: Ocorre logo ap√≥s a conex√£o ser iniciada. O cliente envia qual o seu tipo, e o servidor o insere em um dicion√°rio de \emph{devices} ou de \emph{browsers}, indexado pelo \emph{id} desse socket.

\emph{device\_ping}: √â a metade do caminho do \emph{Ping} lan√ßado pelo \emph{device}. Essa fun√ß√£o emite um evento \emph{server\_ping} de volta ao \emph{device}, com o \emph{timestamp} recebido e o atual.

\emph{device\_add\_speed}: Recebe um conjunto de valores X, Y e Z, e os emite para todos os \emph{browsers}, com o evento \emph{'move'}.

\emph{device\_reset\_speed}: Emite um evento \emph{'device\_log'} para o \emph{device} logar na sua tela, e emite um evento \emph{'reset'} aos \emph{browsers} sem dados. Esse evento √© usado para parar a rota√ß√£o da esfera.

\emph{device\_print}: √â uma fun√ß√£o de \emph{debug}. Somente imprime no console os dados recebidos.

\emph{device\_acceleration}: Recebe os dados do aceler√¥metro do \emph{device} e os emite aos \emph{browsers} com um evento \emph{'update\_acceleration'}.

\emph{echo\_move}: Recebe do \emph{browser} um valor de acelera√ß√£o X, Y e Z, e emite de volta pelo evento \emph{'move'}.

H√° uma fun√ß√£o auxiliar \emph{'emit\_to\_browser\_socket(event, data)'} que emite o evento \emph{'event'} com a mensagem \emph{'data'} para todos os sockets de \emph{'browsers'}.













%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% FIM DA SESS√ÉO ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%










\section{Estudo Aprofundado da Tecnologia}

\subsection{Desenvolvendo Aplicativos com Apache Cordova}


% TODO melhorar

O Apache Cordova √© um \emph{framework} \emph{open-source} para a cria√ß√£o de aplicativos para \emph{mobile}. Seu desenvolvimento √© dado com o uso de tecnologias Web, como HTML5, CSS3 e JavaScript.

Ele √© multiplataforma, permite o desenvolvimento para sistemas como Android, iOS ou navegadores. Por tal motivo, oferece uma API de alto n√≠vel para acessar os m√≥dulos desejados, tais como de sensores, arquivos e rede. A interface para o uso dessas funcionalidades √© abstrata, de forma que c√≥digo desenvolvido √© execut√°vel em todas as plataformas oferecidas e o desenvolvedor n√£o precisa se preocupar com os detalhes de cada uma na hora da implementa√ß√£o.

O aplicativo implementado √© uma exatamente p√°gina Web, a estrutura √© a mesma. H√° um arquivo principal ‚Äúindex.html" que referencia os recursos necess√°rios, como CSS, JavaScript, imagens e arquivos de m√≠dia. A parte l√≥gica √© feita em JavaScript, e a renderiza√ß√£o em HTML5 e CSS3. Para ser portado para uma plataforma espec√≠fica, o HTML √© enviado para a classe \emph{‚ÄúWrapper‚Äù} dessa plataforma, onde est√£o definidos os detalhes de implementa√ß√£o. Essa classe tamb√©m tem incorporada um browser nativo, o \emph{WebView}, que executar√° o programa Web dentro do dispositivo.

A comunica√ß√£o entre o aplicativo e os componentes nativos de cada plataforma √© dada a partir de Plugins instalados. Cada Plugin √© uma biblioteca adicional que permite ao \emph{WebView} interagir com funcionalidades da plataforma nativa na qual est√° rodando. Eles prov√™m acesso a essas funcionalidades normalmente n√£o dispon√≠veis em aplicativos Web. Essas ferramentas s√£o disponibilizadas para o desenvolvedor atrav√©s de uma expans√£o da API inicial, que toma para si os detalhes da implementa√ß√£o em cada plataforma, simplificando o desenvolvimento.

H√° um conjunto principal de Plugins, chamado de \emph{Core}, que √© mantido pelo pr√≥prio Cordova. Nele est√£o contidos os que acessam as principais funcionalidades de um dispositivo mobile, como acesso ao aceler√¥metro, c√¢mera, bateria e geolocaliza√ß√£o.

H√° tamb√©m Plugins desenvolvidos por terceiros (em geral pela pr√≥pria comunidade) que trazem rela√ß√µes com outras funcionalidades, talvez exclusivas de uma plataforma. Enquanto no \emph{Core} h√° apenas umas poucas dezenas, a lista de Plugins criada pela comunidade oferece centenas com as mais diversas funcionalidades, como um para compras dentro do App e um para enviar notifica√ß√µes para dispositivos vest√≠veis (Smartwatches, por exemplo). A cria√ß√£o de um Plugin √© simples e incentivada, no site do Cordova h√° um tutorial.

O m√©todo de desenvolvimento descrito at√© agora, focado em v√°rias plataformas, √© um dentre dois poss√≠veis \emph{Workflows} dispon√≠veis no Cordova e seu nome √© \emph{‚ÄúCross-platform‚Äù} (CLI). Ele deve ser usado se o aplicativo desenvolvido pretende alcan√ßar a maior variedade de Sistemas Operacionais \emph{mobile}, com pouca ou nenhuma √™nfase no desenvolvimento em uma plataforma espec√≠fica.

O segundo \emph{Workflow} √© chamado \emph{‚ÄúPlatform-centered‚Äù}, e deve ser usado se o projeto √© focado para uma √∫nica plataforma e se pretende modific√°-la em baixo n√≠vel.

A arquitetura interna est√° descrita no diagrama:

% TODO adicionar imagem




\subsection{Utilizando Node.js e ExpressJS}

*Something Something*

% https://www.tutorialspoint.com//nodejs/nodejs_introduction.htm
Alguns atributos chave de Node.js s√£o:

% Asynchronous and Event Driven ‚àí All APIs of Node.js library are asynchronous, that is, non-blocking. It essentially means a Node.js based server never waits for an API to return data. The server moves to the next API after calling it and a notification mechanism of Events of Node.js helps the server to get a response from the previous API call.
- Ass√≠ncrono e Orientado a Eventos - Todas as APIs da biblioteca de Node.js s√£o ass√≠ncronas, o que garante que s√£o n√£o bloqueantes. Isso essencialmente significa que um servidor baseado em Node.js n√£o espera por dados de retorno da chamada da API, ele somente continua com sua execu√ß√£o para a pr√≥xima chamada de API. Os dados de retorno chegam ao servidor atr√°ves de um mecanismo de notifica√ß√µes, os Eventos de Node.js. % Cada evento ativa um callback para os dados serem tratados.


% Very Fast ‚àí Being built on Google Chrome's V8 JavaScript Engine, Node.js library is very fast in code execution.
- Muito r√°pido - Por ser constru√≠do com base no V8 JavaScript Engine do Google Chrome, a biblioteca de Node.js √© muito veloz em execu√ß√£o de c√≥digo.

% Single Threaded but Highly Scalable ‚àí Node.js uses a single threaded model with event looping. Event mechanism helps the server to respond in a non-blocking way and makes the server highly scalable as opposed to traditional servers which create limited threads to handle requests. Node.js uses a single threaded program and the same program can provide service to a much larger number of requests than traditional servers like Apache HTTP Server.
- Possui \emph{thread} √∫nica por√©m √© muito escal√°vel - Node.js possui um modelo de la√ßo de Eventos com a utiliza√ß√£o de uma √∫nica \emph{thread}. O mecanismo de Eventos ajuda o servidor enviar respostas de forma n√£o bloqueante e faz o seridor altamente escal√°vel em compara√ß√£o ao modelo tradicional de servidores que criam um n√∫mero limitado de \emph{threads} para lidar com requisi√ß√µes dos clientes. Node.js usa um programa de \emph{thread} √∫nica e esse mesmo programa pode providenciar servi√ßo a um n√∫mero muito maior de requisi√ß√µes do que um servidor tradicional, como o Apache HTTP.

% No Buffering ‚àí Node.js applications never buffer any data. These applications simply output the data in chunks.
- Sem \emph{Buffering} - Aplica√ß√µes em Node.js nunca armazenam nenhum dado em \emph{buffers}. Essas aplia√ß√µes simplesmente enviam dados em blocos.

% License ‚àí Node.js is released under the MIT license.
- Licenciado - Node.js est√° sob uma licen√ßa MIT.







\subsection{Comunica√ß√£o Web e Aplica√ß√µes Web}

A comunica√ß√£o de dados entre computadores atrav√©s da Internet √© algo muito comum, e necessita de uma arquitetura de rede adequada para ocorrer.

(TODO explicar TCP e/ou TCP/IP)
% cliente-servidor
A mais utilizada √© o modelo cliente-servidor. Neste modelo, existem dois tipos de processos rodando, o Cliente e o Servidor. O Cliente √© o processo que roda nos computadores locais, e se conecta ao Servidor. A comunica√ß√£o √© dada quando o Cliente manda uma requisi√ß√£o ao Servidor (esta requisi√ß√£o pode ser por uma p√°gina web, um processamento de dados, entre outros). Por sua vez, o servidor recebe esses dados e faz o processamento necess√°rio para completar essa requisi√ß√£o, e em seguida envia uma resposta ao Cliente. A resposta pode pode ser o que foi requisitado ou outro tipo de mensagem, como de erro, caso ocorra uma falha no processamento ou nega√ß√£o de permiss√£o. O Cliente ent√£o pode continuar com o seu pr√≥prio processo.


(TODO a requisi√ß√£o √© um HTTP, explicar HTTP)

https://www.jmarshall.com/easy/http/


(TODO nota de rodap√©)
% P2P
A outra grande arquitetura muito utilizada tamb√©m √© a peer-to-peer (P2P). Nessa arquitetura, n√£o h√° um computador central para funcionar como servidor, cada computador conectado (Peer) na rede realiza fun√ß√µes tanto de cliente como de servidor na aplica√ß√£o que est√° sendo executada. Essa aplica√ß√£o tem suas tarefas organizadas e divididas entre os Peers.
Essa arquitetura √© conhecida principalmente por ser usada para a transfer√™ncia de arquivos grandes, como m√∫sicas e v√≠deos. Nessa transmiss√£o, os Peers que tem o arquivo s√£o conectados aos que n√£o tem, e come√ßam a transfer√™ncia de pequenos pacotes de dados. Esses pacotes n√£o precisam vir ordenados e o Peer receptor os armazena localmente. Uma vez que a transfer√™ncia √© completada, ele ordena os pacotes e monta o arquivo final. Uma vantagem dessa arquitetura √© que a tranfer√™ncia n√£o √© limitada pela capacidade de banda de Servidor, e Peers podem se conectar e desconectar sem que haja problemas para o receptor, o arquivo s√£o ser√° corrompido por eventuais problemas de conex√£o. Um ponto negativo √© que, sem um Servidor, n√£o h√° um controle de que tipos de arquivos est√£o sendo transferidos (o que abre uma porta para pirataria) e n√£o √© f√°cil interromper uma transfer√™ncia, uma vez que ela pode ser composta de milhares de conex√µes. Outro ponto √© que n√£o √© f√°cil de se conhecer a proced√™ncia dos dados recebidos, a seguran√ßa n√£o pode ser garantida.

Esta arquitetura n√£o serve para as necessidades do projeto, a hip√≥tese de uso foi descartada ap√≥s o estudo de sua estrutura.

%Come√ßo de problemas em usar somente cliente-servidor
Este modelo √© suficiente para p√°ginas Web, pois o cliente pede p√°ginas est√°ticas e o Servidor as fornece sempre que necess√°rio. Mas essa arquitetura n√£o permite um uso mais din√¢mico de websites, pois sua estrutura √© muito burocr√°tica. Para fazer uma p√°gina mais responsiva, com feedbacks a cada a√ß√£o do usu√°rio e dados novos, seria necess√°rio que Cliente fizesse uma requisi√ß√£o ao Servidor ap√≥s o usu√°rio ativar algum gatilho (como preencher um formul√°rio ou levar o cursor a algum ponto espec√≠fico, por exemplo). Como o protocolo dessa requisi√ß√£o √© HTTP, ela possui em seu cabe√ßalho toda a estrutura de dados para ser processado e enviado de volta, tamb√©m com um cabe√ßalho equivalente. Ao receber a p√°gina atualizada, o Cliente ainda precisa recarregar a p√°gina para atualizar o que for necess√°rio. H√° dois problemas claros nessa estrutura:

- A necessidade de recarregar a p√°gina inteira, mesmo que somente uma pequena parcela dos dados tenha sido alterada. Esse comportamento foi criado em um momento no qual n√£o se tinha a necessidade de alterar pequenas coisas, na p√°gina, e que cada HTML vindo do Servidor seria uma p√°gina completamente nova. A impossibilidade de atualizar dados individualmente remove qualquer dinamicidade desejada.

- O overhead gerado pelas pelo cabe√ßalho das requisi√ß√µes e repostas com o protocolo HTTP. Esse overhead cria uma lat√™ncia alta e faz com que um envio contante de requisi√ß√µes ao Servidor exija muitos recursos.

Um exemplo de comportamento imposs√≠vel com essas restri√ß√µes √© dar um feedback instant√¢neo para o usu√°rio na hora que ele est√° preenchendo um cadastro em algum site, como informar se o email inserido j√° foi usado, ou se a senha possui os par√¢metros m√≠nimos necess√°rios de seguran√ßa.

(TODO verificar se) A conex√£o s√≥ dura durante o processo de requisi√ß√£o entre ambos, ela √© fechada uma vez que a requisi√ß√£o √© satisfeita.

% Apresento Ajax
Da discuss√£o gerada √† partir desses problemas, surgiu o Ajax (Asynchronous JavaScript e XML). Ajax √© uma t√©cnica de desenvolvimento Web usada para fazer requisi√ß√µes ao Servidor para receber dados no background de forma ass√≠ncrona, sem precisar recarregar a p√°gina inteira. Com ele, √© poss√≠vel receber dados novos e atualiz√°-los no c√≥digo sem alterar o resto da p√°gina. Isso com essa t√©cnica passa a ser poss√≠vel atualizar partes de uma p√°gina com base em eventos do usu√°rio.

% Exemplo de Ajax
Para ilustrar esse funcionamento com um exemplo simples, basta usar a ferramenta de busca do Google (TODO link). O usu√°rio come√ßa a digitar uma busca e os resultados j√° come√ßam a aparecer sem a necessidade de atualizar a p√°gina, mesmo antes da busca estar completa (TODO imagem). O input do usu√°rio ativa requisi√ß√µes no background para obter e atualizar os resultados exibidos, sem se preocupar se a busca ser√° alterada no futuro. Assim, o usu√°rio recebe um feedback muito mais din√¢mico e menos burocr√°tico do que o convencional (digitar a busca completa e ir para uma p√°gina de resultados).

% Final de Ajax
Com o Ajax, nota-se uma mudan√ßa de paradigmas na Web. Onde antes s√≥ havia a no√ß√£o de p√°gina Web, agora come√ßa a se formar uma no√ß√£o de Aplica√ß√£o Web. Antes, a maior interatividade poss√≠vel era algo como um fluxo de telas com dados dependentes da tela passada, mas agora a√ß√µes de usu√°rios passam a ter resultados instant√¢neos. Sites com um fluxo de dados muito grande e din√¢mico passam a ser poss√≠veis, como Facebook (TODO link), no qual √© poss√≠vel fazer coment√°rios, interagir com usu√°rios e visualizar tanto conte√∫do quando desejado sem precisar atualizar a p√°gina.

% Come√ßo da necessidade de comunica√ß√£o bilateral
Essa mudan√ßa de paradigmas fez com que muitas Aplica√ß√µes tipicamente executadas em Desktop fossem desenvolvidas para Web, como Chats ou aplica√ß√µes que exigissem um fluxo de dados muito grande entre o Cliente e o Servidor. O que ficou claro com o tempo √© que Ajax n√£o bastava para muitas dessas Aplica√ß√µes, em espec√≠fico as que funcionavam em tempo real. Muitas vezes √© o Servidor que precisa se comunicar ao Cliente sobre mudan√ßa nos dados. O modelo de funcionamento do Ajax n√£o possui esse tipo de interface, ent√£o, para fazer aplica√ß√µes assim funcionarem corretamente, √© necess√°rio muito esfor√ßo, lutar muito com a linguagem.

% Exemplo da necessidade de comunica√ß√£o bilateral
Um exemplo claro disso √© uma aplica√ß√£o de Chat. N√£o √© poss√≠vel ter um padr√£o de quando o Servidor tem novas mensagens, ent√£o √© necess√°rio que o Cliente fa√ßa requisi√ß√µes a cada per√≠odo de tempo. Se esse per√≠odo for curto, o fluxo de dados intenso pode se tornar um problema. Se o per√≠odo for longo, vai contra o princ√≠pio de ser uma comunica√ß√£o em tempo real, mensagens v√£o demorar mais a serem entregues. Al√©m disso, o modelo de comunica√ß√£o do Ajax enviar e recebe mensagens em paralelo, sem preservar sua ordem. Ent√£o, ao se fazer atualiza√ß√µes s√≠ncronas, √© necess√°rio ainda mais uma verifica√ß√£o para exibir mensagens em ordem cronol√≥gica.

% Conclus√£o Ajax e necessidade de CommBi
A necessidade de v√°rios tratamentos para uma aplica√ß√£o relativamente simples funcionar deixa claro que h√° necessidade de mais ferramentas para o desenvolvimento de aplica√ß√µes Web.


\subsubsection{Necessidade de Comunica√ß√£o Bilateral}


% Maneiras de simular CommBi

Um dos fatores mais limitantes era que a comunica√ß√£o cliente-servidor n√£o era bilateral. N√£o era poss√≠vel para o Servidor mandar dados espontaneamente, sem que o Cliente tivesse feito uma requisi√ß√£o antes. Para contornar esse problema foram criadas t√©cnicas para simular essa comunica√ß√£o bilateral: Polling, Long-Polling e Streaming.

\subsubsection{Polling}

Essa t√©cnica j√° foi descrita acima no exemplo do Chat. Ela consiste em fazer o cliente mandar requisi√ß√µes em intervalos regulares de tempo e receber a resposta logo em seguida. Ela foi a primeira tentativa de se contornar o problema, principalmente por ser a implementa√ß√£o mais simples e direta. Essa solu√ß√£o √© boa quando se sabe o tempo de atualiza√ß√£o de dados no servidor, pois ent√£o √© poss√≠vel sincronizar os tempos de requisi√ß√£o e atualiza√ß√£o. Por√©m esse √© somente um dos cen√°rios poss√≠veis, dados em tempo real n√£o costumam ser t√£o previs√≠veis, ent√£o √© inevit√°vel que uma parcela dessas requisi√ß√µes seja desnecess√°ria e muitas conex√µes sejam abertas e fechadas sem necessidade, em momentos de baixo fluxo de atualiza√ß√£o do servidor.


\subsubsection{Long-Polling}

No Long-Polling, o cliente manda uma requisi√ß√£o e o servidor a mant√©m aberta durante um determinado per√≠odo de tempo. Se uma atualiza√ß√£o chegar durante esse per√≠odo, a resposta √© enviada ao cliente com esses dados novos. Se o tempo acabar sem que haja mudan√ßas, o servidor envia uma resposta para encerrar a requisi√ß√£o aberta. Essa t√©cnica apresenta melhoras em rela√ß√£o ao Polling, por√©m, se existe um fluxo alto de atualiza√ß√µes no servidor, ela n√£o oferece nenhuma melhora substancial em rela√ß√£o a ele. Nessa situa√ß√£o ali√°s, o Long-Polling pode ser pior, pois pode ficar inst√°vel em um loop cont√≠nuo de Polls imediatos.


% https://jfarcand.wordpress.com/2007/05/15/new-adventures-in-comet-polling-long-polling-or-http-streaming-with-ajax-which-one-to-choose/
% Use long polling when your AJAX application doesn‚Äôt need to be updated every second. Why? Because getting server push every second (or few seconds) is mostly doing the same as polling. I would for use use long polling for AJAX applications that get updated every 30 seconds or more. Again I don‚Äôt have any performance data (yet!) to prove this blind statement.
% Use Http streaming when your AJAX application requires frequent updates. To be coherent with myself, it means AJAX application that needs to be updated every few seconds. I would avoid using Http streaming if the server normally push data every 5 minutes as an example. I would instead use long polling as the price of re-opening the connection is probably lower than keeping the connection opened for such a long time, as you are wasting a resource. Again, a blank statement only based on my experience. But stay tuned for performance data associated with each techniqueüòâ.


% https://tools.ietf.org/id/draft-loreto-http-bidirectional-07.html#timeouts

% 5.5.  Timeouts

% The HTTP long polling mechanism allows the server to respond to a request only when a particular event, status, or timeout has occurred. In order to minimize as much as possible both latency in server-client message delivery and the processing/network resources needed, the long polling request timeout ought to be set to a high value.

% However, the timeout value has to be chosen carefully; indeed, problems can occur if this value is set too high (e.g., the client might receive a 408 Request Timeout answer from the server or a 504 Gateway Timeout answer from a proxy). The default timeout value in a browser is 300 seconds, but most network infrastructures include proxies and servers whose timeout is not that long.

% Several experiments have shown success with timeouts as high as 120 seconds, but generally 30 seconds is a safer value. Therefore vendors of network equipment wishing to be compatible with the HTTP long polling mechanism are advised to implement a timeout substantially greater than 30 seconds (where "substantially" means several times more than the medium network transit time).


\subsubsection{Streaming}

Com a t√©cnica de streaming, o cliente manda uma requisi√ß√£o, e o servidor manda e mant√©m uma resposta aberta, que √© atualizada continuamente, sem ter um momento certo para ser fechada (um intervalo de tempo pode ser definido, mas normalmente a conex√£o √© mantida indefinidamente). Essa resposta √© atualizada sempre que h√° novos dados no servidor, mas ele nunca manda um sinal para completar a resposta e encerrar a conex√£o. O ponto negativo dessa t√©cnica √© que, como o streaming ainda √© encapsulado no HTTP, √© poss√≠vel que firewalls e servidores proxy possam escolher armazenar a resposta em um buffer, o que aumenta muito a lat√™ncia da mensagem.


% Mais problemas e conclus√£o
Por fim, todas essas t√©cnicas envolvem requisi√ß√µes e respostas com um cabe√ßalho HTTP, que cont√©m muitos dados desnecess√°rios para esse uso, gerando lat√™ncia. Al√©m disso, uma verdadeira conex√£o bilateral requer mais do que o fluxo de dados vindo do servidor, √© necess√°rio tamb√©m ter o fluxo originado no cliente. Para fazer uma simula√ß√£o mais consistente com o desejado, muitas solu√ß√µes hoje usam duas conex√µes de fluxo, uma para o cliente e uma para o servidor. A coordena√ß√£o e manuten√ß√£o dessas duas conex√µes paralelas gera um overhead ainda maior em termos de recursos, al√©m do claro aumento de complexidade do c√≥digo.

% In√≠cio de Websockets
Por todos esses fatos, ficou claro que era necess√°rio ter uma conex√£o bilateral de verdade. Para que essa conex√£o fosse poss√≠vel, era necess√°rio ter um controle maior da transfer√™ncia de dados era necess√°rio. Dentro do protocolo TCP(TODO verificar informa√ß√£o), esse controle √© feito por meio dos Sockets, mas, at√© ent√£o, eles eram indispon√≠veis ao desenvolvimento Web, n√£o havia interface de intera√ß√£o.


\subsubsection{Sockets}

No modelo cliente-servidor uma conex√£o √© dada por dois pontos finais, um no Cliente e um no Servidor. Essa √© a conex√£o de baixo n√≠vel definida pelo protocolo TCP. Cada um desses pontos finais serve para mandar e receber os dados em rela√ß√£o ao outro lado da conex√£o e eles s√£o nomeados como Soquetes de Rede (Sockets). Cada Socket √© definido por um endere√ßo de IP e uma Porta (por exemplo, 192.168.0.1:8000), independente se est√° no Cliente ou no Servidor, e a conex√£o TCP √© definida de maneira √∫nica por seus dois Sockets.

A conex√£o cliente-servidor, considerando os Sockets, √© feita da seguite maneira:

No lado do cliente, Primeiramente ele precisa saber o endere√ßo de IP da m√°quina onde o servidor roda e a porta que ouve (esses dados definem o socket do servidor). Ele ent√£o envia um sinal a esse socket para pedir a conex√£o. Nesse sinal h√° um identificador, que contem seu pr√≥prio IP e uma porta escolhida na hora, para que o servidor saiba a quem enviar as respostas. √â importante ter em mente que o cliente n√£o possui um socket ainda, ele ser√° criado caso a conex√£o seja bem sucedida.
No lado do servidor, se n√£o ocorrer nenhum erro, a conex√£o √© aceita. Neste momento, o servidor cria um novo socket com o mesmo IP e porta local do original, para conect√°-lo com o cliente. Esse novo socket √© necess√°rio para que o servidor possa continuar ouvindo a outras conex√µes naquela porta com o socket original, enquanto a c√≥pia passa a ser exclusiva ao cliente.
De volta ao cliente, se a conex√£o √© aceita, o seu socket √© criado (com as especifica√ß√µes que foram enviadas no pedido).

Agora o cliente e o servidor podem se comunicar com leitura ou escrita nesses novos sockets criados.

% TODO Sei l√° se vou falar disso
% A API b√°sica para manipula√ß√£o de Sockets :

% SOCKET : Cria um ponto final de uma comunica√ß√£o.
% BIND : Associa um endere√ßo local a um Socket.
% LISTEN : Anuncia que aceita conex√µes, e d√° o tamanho da queue.
% ACCEPT : Aceita um pedido de conex√£o.
% CONNECT : Envia um pedido de conex√£o.
% SEND : Envia dados atrav√©s de sua conex√£o.
% RECEIVE : Recebe dados vindos de sua conex√£o.
% CLOSE : Encerra a conex√£o.



\subsubsection{Websockets}

% https://www.websocket.org/aboutwebsocket.html

% WebSocket √© o protocolo que lida com os Sockets de uma conex√£o que foi criada para permitir a comunica√ß√£o bilateral entre o cliente e o servidor. Ele d√° ao programador mais liberdade para criar novos protocolos e novas maneiras de se transferir dados, em ambas as dire√ß√µes.

% A interface em si √© bastante simples, seu objetivo √© o envio e recebimento de mensagens entre o cliente e o servidor. Na realidade, para o protocolo, n√£o existe essa diferencia√ß√£o entre os dois, eles s√£o apenas dois processos conectados. Essa hierarquia deixa de existir e n√£o h√° mais uma separa√ß√£o de fun√ß√µes entre ambos. A comunica√ß√£o √© dada por envio de mensagens e ocorr√™ncia de eventos. Esses processos podem enviar mensagens a qualquer momento e est√£o ouvindo um ao outro.

% O protocolo foi pensado para funcionar bem com a infraestrutura Web j√° existente. Como parte desse paradigma, sua especifica√ß√£o determina que uma conex√£o √© estabelecida inicialmente com o protocolo HTTP, garantindo retrocompatibilidade.

% A conex√£o WebSocket √© feita da seguinte forma. Ap√≥s inciada a conex√£o HTTP, o browser envia uma requisi√ß√£o ao servidor indicando que deseja trocar de protocolos, de HTTP para WebSocket. Se o servidor entende esse protocolo, ele envia uma resposta para permitir a troca. Nesse momento a conex√£o HTTP √© interrompida e a conex√£o WebSocket toma o seu lugar. Esse processo √© chamado de WebSocket Handshake.

% A estrutura da mensagem em WebSocket √© m√≠nima. O corpo da mensagem, os dados a serem enviados, s√≥ possui dois formatos, texto ou bin√°rio. O cabe√ßalho cont√©m um identificador de tipo do formato, que tem um campo para o tamanho da mensagem e nada mais. A mensagem completa √© s√≥ o conte√∫do mais o seu tamanho. Como a conex√£o n√£o muda em momento algum, todas as informa√ß√µes contidas no cabe√ßalho de requisi√ß√£o e resposta HTTP s√£o invariantes e, portanto, n√£o precisam ser reenviadas.

% Um desses processos, em um momento arbitr√°rio, envia uma mensagem ao outro, talvez porque dados tenham sido atualizados ou o usu√°rio tenha feito alguma a√ß√£o em espec√≠fico. Uma vez que a mensagem √© enviada, esse processo volta ao que estava fazendo, sem a necessidade de esperar uma resposta (com a exce√ß√£o talvez de qualquer confirma√ß√£o sobre a entrega). Esse comportamento √© chamado de ass√≠ncrono, pois n√£o necessita de uma resposta para continuar com sua execu√ß√£o.

% O outro processo v√™ a chegada dessa nova mensagem como um evento. Quando esse evento acontece, ele executa um comportamento espec√≠fico com os dados recebidos, como altera√ß√£o de informa√ß√µes exibidos ou um c√°lculo com os valores novos. Por isso √© dito que Websocket √© voltado a eventos.

% %(TODO bulletpoints)
% Existem 4 tipos de eventos e o comportamento que eles executam √© definido quando o Websocket √© criado. Esses eventos s√£o:
% - onopen: executado quando a conex√£o √© feita,
% - onclose: executado quando a conex√£o √© fechada,
% - onmessage: executado quando uma mensagem do outro WebSocket chega,
% - onerror: executado se h√° algum erro na conex√£o.


Para ilustrar melhor esse comportamento de conex√£o, mensagens e eventos, abaixo h√° um exemplo em HTML de uma p√°gina que utiliza WebSockets.

(TODO link)
https://www.websocket.org/echo.html

\begin{small}
\begin{Verbatim}[frame=single]
  <!DOCTYPE html>
  <meta charset="utf-8" />
  <title>WebSocket Test</title>
  <script language="javascript" type="text/javascript">

  var wsUri = "ws://echo.websocket.org/";
  var output;

  function init()
  {
    output = document.getElementById("output");
    testWebSocket();
  }

  function testWebSocket()
  {
    websocket = new WebSocket(wsUri);
    websocket.onopen = function(evt) { onOpen(evt) };
    websocket.onclose = function(evt) { onClose(evt) };
    websocket.onmessage = function(evt) { onMessage(evt) };
    websocket.onerror = function(evt) { onError(evt) };
  }

  function onOpen(evt)
  {
    writeToScreen("CONNECTED");
    doSend("WebSocket rocks");
  }

  function onClose(evt)
  {
    writeToScreen("DISCONNECTED");
  }

  function onMessage(evt)
  {
    writeToScreen('<span style="color: blue;">RESPONSE: ' + evt.data+'</span>');
    websocket.close();
  }

  function onError(evt)
  {
    writeToScreen('<span style="color: red;">ERROR:</span> ' + evt.data);
  }

  function doSend(message)
  {
    writeToScreen("SENT: " + message);
    websocket.send(message);
  }

  function writeToScreen(message)
  {
    var pre = document.createElement("p");
    pre.style.wordWrap = "break-word";
    pre.innerHTML = message;
    output.appendChild(pre);
  }

  window.addEventListener("load", init, false);

  </script>

  <h2>WebSocket Test</h2>

  <div id="output"></div>

\end{Verbatim}
\end{small}


Essa p√°gina executa um c√≥digo simples. Ela cria um WebSocket conectado √† ‚Äúws://echo.websocket.org/".

O evento de conex√£o (onOpen) ativa uma fun√ß√£o que escreve na tela e manda uma string para o outro WebSocket.

O evento de recebimento de mensagem (onMessage) escreve na tela o conte√∫do que foi recebido e fecha a conex√£o.

O evento de encerramento de conex√£o e de erro (onClose e onError) s√≥ escrevem na tela um status.





\subsubsection{Teste de efici√™ncia de Websockets}


No experimento a seguir, √© mostrado a diferen√ßa de tr√°fego de dados e lat√™ncia entre Websocket e Polling para requisitar dados em tempo real. Ele foi retirado do site https://www.websocket.org/quantum.html , e √© somente transcrito aqui, em tradu√ß√£o livre:

(TODO REF https://www.websocket.org/quantum.html)

%----------------------------------------------------

Informa√ß√µes para entender o exemplo:
RabbitMQ Message Broker: um simples programa que recebe e encaminha mensagens. Nesse exemplo ele est√° em um servidor, recebe dados de um mercado de a√ß√µes fict√≠cio. (TODO REF: https://www.rabbitmq.com/tutorials/tutorial-one-python.html)
Java Servlet: uma classe Java usada para estender as funcionalidades de um servidor. Pode ser definido como um componente semelhante um servidor, que gera dados HTML e XML para a camada de apresenta√ß√£o de uma aplica√ß√£o Web. Ele processa dinamicamente requisi√ß√µes e respostas. (TODO REF: https://pt.wikipedia.org/wiki/Servlet)
Mozilla Firefox: Browser muito utilizado.
Firebug: .
%a Firefox add-on that allows you to debug web pages and monitor the time it takes to load pages and execute scripts
%----------------------------------------------------

% So how dramatic is that reduction in unnecessary network traffic and latency? Let's compare a polling application and a WebSocket application side by side.
O qu√£o dram√°tica √© a redu√ß√£o de tr√°fego de dados desnecess√°rios e lat√™ncia? Vamos comparar uma aplica√ß√£o Polling e uma WebSocket lado a lado.


% For the polling example, I created a simple web application in which a web page requests real-time stock data from a RabbitMQ message broker using a traditional publish/subscribe model. It does this by polling a Java Servlet that is hosted on a web server. The RabbitMQ message broker receives data from a fictitious stock price feed with continuously updating prices. The web page connects and subscribes to a specific stock channel (a topic on the message broker) and uses an XMLHttpRequest to poll for updates once per second. When updates are received, some calculations are performed and the stock data is shown in a table as shown in the following image.
Para o exemplo de Polling, eu criei uma simples aplica√ß√£o Web, na qual a p√°gina manda requisi√ß√µes a um RabbitMQ Message Broker pedindo dados de um Mercado de A√ß√µes em tempo real, usando um modelo publish/subscribe tradicional. Ele requisita esses dados por fazer Polling para uma Java Servlet hospedado no Servidor Web. O RabbitMQ Message Broker recebe os dados de um feed de Mercado de A√ß√µes fict√≠cio, atualizado continuamente. A p√°gina Web conecta e se inscreve em um canal espec√≠fico do Mercado (um T√≥pico do Message Broker) e usa uma chamada XMLHttpRequest para pedir (fazer um Poll) por updates uma vez por segundo. Quando updates chegam, alguns c√°lculos s√£o feitos e os dados do Mercado s√£o mostrados em uma tabela, como na imagem a seguir

% Figure 2 ‚Äî A JavaScript stock ticker application
(TODO imagem)

% Note: The back-end stock feed actually produces a lot of stock price updates per second, so using polling at one-second intervals is actually more prudent than using a Comet long-polling solution, which would result in a series of continuous polls. Polling effectively throttles the incoming updates here.
Nota: O feed no T√≥pico do Mercado produz muitas atualiza√ß√µes de pre√ßo por segundo, ent√£o usar Polling com um segundo de intervalo √© mais prudente do que Long-Polling, pois ele resultaria em uma s√©rie de Polls cont√≠nuos. O Polling controla de forma efetiva a vinda de atualiza√ß√µes.

% It all looks great, but a look under the hood reveals there are some serious issues with this application. For example, in Mozilla Firefox with Firebug (a Firefox add-on that allows you to debug web pages and monitor the time it takes to load pages and execute scripts), you can see that GET requests hammer the server at one-second intervals. Turning on Live HTTP Headers (another Firefox add-on that shows live HTTP header traffic) reveals the shocking amount of header overhead that is associated with each request. The following two examples show the HTTP header data for just a single request and response.
Tudo parece certo, mas ao se olhar o funcionamento, √© revelado que h√° problemas s√©rios com essa aplica√ß√£o. Por exemplo, com o Firebug (um add-on do Mozilla Firefox que pemite fazer o debug de uma p√°gina Web e monitorar o tempo que ela para carregar p√°ginas e executar scripts), voc√™ consegue ver que a requisi√ß√£o GET martela o Servidor em invervalos de 1 segundo. Ativando o Live HTTP Headers (outro add-on do Mozilla Firefox que mostra ao vivo o tr√°fego de cabe√ßalhos HTTP), √© revelado o enorme overhead causado por cabe√ßalhos associados a cada requisi√ß√£o. Os dois pr√≥ximos exemplos mostram o cabe√ßalho HTTP para somente uma requisi√ß√£o e uma resposta.

% TODO formata√ß√£o
Exemplo 1 ‚Äî cabe√ßalho de requisi√ß√£o HTTP
\begin{small}
\begin{Verbatim}[frame=single]
 GET /PollingStock//PollingStock HTTP/1.1
 Host: localhost:8080
 User-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.9.1.5)
 Gecko/20091102 Firefox/3.5.5
 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
 Accept-Language: en-us
 Accept-Encoding: gzip,deflate
 Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7
 Keep-Alive: 300
 Connection: keep-alive
 Referer: http://www.example.com/PollingStock/
 Cookie: showInheritedConstant=false;
 showInheritedProtectedConstant=false;
 showInheritedProperty=false;
 showInheritedProtectedProperty=false;
 showInheritedMethod=false;
 showInheritedProtectedMethod=false;
 showInheritedEvent=false;
 showInheritedStyle=false;
 showInheritedEffect=false
\end{Verbatim}
\end{small}

Exemplo 2 ‚Äî cabe√ßalho de resposta HTTP
\begin{small}
\begin{Verbatim}[frame=single]
HTTP/1.x 200 OK
X-Powered-By: Servlet/2.5
Server: Sun Java System Application Server 9.1_02
Content-Type: text/html;charset=UTF-8
Content-Length: 21
Date: Sat, 07 Nov 2009 00:32:46 GMT
\end{Verbatim}
\end{small}

% Just for fun, I counted all the characters. The total HTTP request and response header information overhead contains 871 bytes and that does not even include any data! Of course, this is just an example and you can have less than 871 bytes of header data, but I have also seen cases where the header data exceeded 2000 bytes. In this example application, the data for a typical stock topic message is only about 20 characters long. As you can see, it is effectively drowned out by the excessive header information, which was not even required in the first place!
S√≥ por divers√£o, eu contei todos os characteres. O total de overhead de informa√ß√£o na requisi√ß√£o e resposta HTTP possui 871 bytes, sem incuir nenhum dado! Claro, esse √© somente um exemplo e voc√™ pode ter menos de 871 bytes de cabe√ßalho, mas eu tamb√©m vi casos onde ele ultrapassava 2000 bytes. Nessa aplica√ß√£o de exemplo, uma mensagem t√≠pica do T√≥pico de Mercado cont√©m em torno de 20 characteres. Como voc√™ pode ver, ela √© efetivamente afogada pelo excesso de informa√ß√£o do cabe√ßalho, que nem √© necess√°rio no final das contas!

% So, what happens when you deploy this application to a large number of users? Let's take a look at the network throughput for just the HTTP request and response header data associated with this polling application in three different use cases.
Ent√£o, o que acontece quando voc√™ deploy (TODO I18n) essa aplica√ß√£o para um grande n√∫mero de usu√°rios? Vamos observar o tr√°fego de dados somente dos dados do cabe√ßalho HTTP de requisi√ß√£o e resposta associados a essa aplica√ß√£o de Polling em tr√™s casos diferentes.

% Use case A: 1,000 clients polling every second: Network throughput is (871 x 1,000) = 871,000 bytes = 6,968,000 bits per second (6.6 Mbps)
% Use case B: 10,000 clients polling every second: Network throughput is (871 x 10,000) = 8,710,000 bytes = 69,680,000 bits per second (66 Mbps)
% Use case C: 100,000 clients polling every 1 second: Network throughput is (871 x 100,000) = 87,100,000 bytes = 696,800,000 bits per second (665 Mbps)
(TODO formata√ß√£o)
Caso de uso A: 1,000 clientes fazendo Polling a cada segundo: tr√°fego de dados √© (871 x 1,000) = 871,000 bytes = 6,968,000 bits por segundo. (6.6 Mbps)
Caso de uso B: 10,000 clientes fazendo Polling a cada segundo: tr√°fego de dados √© (871 x 10,000) = 8,710,000 bytes = 69,680,000 bits por segundo. (66 Mbps)
Caso de uso C: 100,000 clientes fazendo Polling a cada segundo: tr√°fego de dados √© (871 x 100,000) = 87,100,000 bytes = 696,800,000 bits por segundo. (665 Mbps)

(TODO explicar HTML5?)
% That's an enormous amount of unnecessary network throughput! If only we could just get the essential data over the wire. Well, guess what? You can with HTML5 Web Sockets! I rebuilt the application to use HTML5 Web Sockets, adding an event handler to the web page to asynchronously listen for stock update messages from the message broker (check out the many how-tos and tutorials on tech.kaazing.com/documentation/ for more information on how to build a WebSocket application). Each of these messages is a WebSocket frame that has just two bytes of overhead (instead of 871)! Take a look at how that affects the network throughput overhead in our three use cases.
Essa √© uma quatidade enorme de tr√°fego de dados desnecess√°rios! Imagina s√≥ se fosse poss√≠vel transferir a informa√ß√£o necess√°ria. Ent√£o, com HTML5 Web Sockets voc√™ pode! Eu reconstrui a aplica√ß√£o usando HTML5 Web Sockets, adicionando um manipulador de evento para que a p√°gina Web possa assincronamente ouvir por mensagens do Message Broker de atualiza√ß√µes do pre√ßo do Mercado. Cada uma dessas mensagens √© um WebSocket frame que possui s√≥ 2 bytes de overhead (ao inv√©s de 871)! Veja como isso afeta o tr√°fego de dados de overhead naqueles tr√™s casos.

% Use case A: 1,000 clients receive 1 message per second: Network throughput is (2 x 1,000) = 2,000 bytes = 16,000 bits per second (0.015 Mbps)
% Use case B: 10,000 clients receive 1 message per second: Network throughput is (2 x 10,000) = 20,000 bytes = 160,000 bits per second (0.153 Mbps)
% Use case C: 100,000 clients receive 1 message per second: Network throughput is (2 x 100,000) = 200,000 bytes = 1,600,000 bits per second (1.526 Mbps)

Caso de uso A: 1,000 clientes recebem 1 mensagem por segundo: Tr√°fego de dados √© (2 x 1,000) = 2,000 bytes = 16,000 bits por segundo (0.015 Mbps)
Caso de uso B: 10,000 clientes recebem 1 mensagem por segundo: Tr√°fego de dados √© (2 x 10,000) = 20,000 bytes = 160,000 bits por segundo (0.153 Mbps)
Caso de uso C: 100,000 clientes recebem 1 mensagem por segundo: Tr√°fego de dados √© (2 x 100,000) = 200,000 bytes = 1,600,000 bits por segundo (1.526 Mbps)

% As you can see in the following figure, HTML5 Web Sockets provide a dramatic reduction of unnecessary network traffic compared to the polling solution.
Como voc√™ pode ver na figura abaixo, HTML5 Web Sockets prov√™ uma redu√ß√£o dram√°tica no tr√°fego de dados desnecess√°rios em rela√ß√£o ao m√©todo de Polling.
(TODO I18n de ~polling solution~)

% Figure 3 ‚Äî Comparison of the unnecessary network throughput overhead between the polling and the WebSocket applications
(TODO Figura 3)

% And what about the reduction in latency? Take a look at the following figure. In the top half, you can see the latency of the half-duplex polling solution. If we assume, for this example, that it takes 50 milliseconds for a message to travel from the server to the browser, then the polling application introduces a lot of extra latency, because a new request has to be sent to the server when the response is complete. This new request takes another 50ms and during this time the server cannot send any messages to the browser, resulting in additional server memory consumption.
E em rela√ß√£o √† redu√ß√£o na lat√™ncia? Veja a figura abaixo. Na metade de cima, voc√™ consegue a lat√™ncia do m√©todo de Polling. Se assumirmos, nesse exemplo, que √© necess√°rio 50 milissegundos para uma mensagem chegue do Servidor para o browser, ent√£o a aplica√ß√£o de Polling introduz muita lat√™ncia extra, porque cada nova requisi√ß√£o precisa ser enviada ao Servidor quando a resposta est√° completa. Essa nova requisi√ß√£o requer outros 50 milissegundos, e, durante esse tempo, o Servidor n√£o consegue mandar qualquer outra mensagem ao browser, resultando em um consumo de mem√≥ria adicional ao Servidor.

% In the bottom half of the figure, you see the reduction in latency provided by the WebSocket solution. Once the connection is upgraded to WebSocket, messages can flow from the server to the browser the moment they arrive. It still takes 50 ms for messages to travel from the server to the browser, but the WebSocket connection remains open so there is no need to send another request to the server.
Na metade de baixo da figura, voc√™ v√™ a redu√ß√£o na lat√™ncia proporcionada pelo uso de WebSocket. Uma vez que a conex√£o √© upgraded (TODO I18n) para Websocket, as mensagens podem fluir do Servidor ao browser no momento em que surgem. Ainda leva 50 milissegundos para as mensagens atravessarem do Servidor ao cliente, mas a conex√£o Websocket permanece aberta para que n√£o haja necessidade de enviar outra requisi√ß√£o ao Servidor.


% Figure 4 ‚Äî Latency comparison between the polling and WebSocket applications
(TODO Figura 4)

~ Final do exemplo ~

%----------------------------------------------------


Em conclus√£o, WebSocket √© a solu√ß√£o ideal para problemas apresentados anteriormente. √â um protocolo feito para a real comunica√ß√£o plenamente bilateral e obt√©m isso com o menor gasto de recursos poss√≠vel. Com ele, a cria√ß√£o de aplica√ß√µes Web se torna muito mais vi√°vel e popular.

Mas existe um problema nesse meio de desenvolvimento Web, que √© o fato de que a todo momento a infraestrutura √© alterada. Novos protocolos s√£o criados, outros s√£o atualizados, antigos deixam de funcionar corretamente. Esse √© um problema inerente ao meio e que afeta a todos.

% https://pt.wikipedia.org/wiki/SPDY
Para ilustrar esse fato, vamos tomar como exemplo o protocolo SPDY (pronunciado ‚Äúspeedy"), desenvolvido principalmente pela Google. (TODO rodap√©: Ele n√£o √© um protocolo padr√£o, por√©m √© bastante promissor e √© est√° sendo utilizado para o desenvolvimento do protocolo HTTP 2.0)

Em linhas gerais, esse protocolo busca velocidade e se baseia no fato de que, se uma conex√£o √© estabelecida com o servidor e o cliente come√ßa a enviar muitas requisi√ß√µes HTTP, essas requisi√ß√µes v√£o incluir informa√ß√µes repetidas, comuns √†quela sess√£o. Ele define ent√£o que, ao inv√©s de enviar essas informa√ß√µes desnecess√°rias repetidamente durante a sess√£o, o servidor passa a salvar em um dicion√°rio os usu√°rios conectados e utilizar essas informa√ß√µes salvas. Por conta disso, fazer requisi√ß√µes passa a ser mais r√°pido e consumir menos recursos. (TODO rodap√©: note a semelhan√ßa com WebSockets)

Tamb√©m para aumentar a velocidade, o SPDY multiplexa requisi√ß√µes para permitir que sejam feitas em paralelo. Atualmente no protocolo HTTP as requisi√ß√µes s√£o todas feitas em s√©rie. O problema aparece nesse momento, pois o WebSocket esperava ter um socket TCP/IP dedicado e agora passa a funcionar em cima de uma camada de conex√£o SPDY multiplexada.

O WebSocket (assim como outros protocolos e ferramentas) necessitam de  atualiza√ß√µes de tempos em tempos, por situa√ß√µes inevit√°veis como essa. Essa mudan√ßa constante aumenta o n√≠vel de dificuldade para o desenvolvedor estar sempre atualizado com seus detalhes de implementa√ß√£o.

Uma das maneiras de se contornar essa dificuldade √© utillizar outras APIs que cuidam desses detalhes internamente.


\subsubsection{Socket.io}
% https://davidwalsh.name/websocket


% Socket.io √© uma API de WebSocket para JavaScript, que √© utilizada nesse Projeto. Ele busca cuidar de todos os detalhes de funcionamento do protocolo internamente, deixando uma interface simples ao usu√°rio.

% Para uma conex√£o ser estabelecida, tanto o cliente quanto o servidor precisam estar executando Socket.io. Sua implementa√ß√£o tenta primeiramente fazer a conex√£o usando WebSocket, mas se o servidor n√£o suporta esse protocolo, ele recua (faz fallback) para outras tecnologias, como AJAX long-polling, AJAX multipart streaming, IFrame, JSONP polling, entre outros (todos utilizando a mesma interface). Esse fallback abrange uma quantidade muito maior de servidores, permitindo um uso n√£o t√£o restrito dessa API.

% Al√©m da implementa√ß√£o b√°sica do protocolo WebSocket, ele tamb√©m outras funcionalidades muito importantes para o desenvolvimento de uma aplica√ß√£o maior e mais robusta.


% √â poss√≠vel conectar m√∫ltiplos sockets em uma mesma porta. Internamente, ele faz uma multiplexa√ß√£o das v√°rias conex√µes abertas em uma mesma porta, mas os processos entendem que tem um socket dedicado a eles. Utilizando WebSockets, cada socket precisa de uma porta exclusiva para fazer a conex√£o.

% A possibilidade de v√°rios sockets em uma mesma aplica√ß√£o permite uma modulariza√ß√£o muito maior, pois n√£o √© necess√°rio que um m√≥dulo saiba se tem uma conex√£o dedicada ou se est√° compartilhando com mais dezenas de outros sockets.

% Ele permite tamb√©m a cria√ß√£o arbritr√°ria de eventos. Com WebSocket, o desenvolvedor fica preso aos quatro eventos pr√© definidos: onopen, onclose, onmessage e onerror. Internamente, os quatro s√£o eventos de mensagem, disparados em momentos e situa√ß√µes espec√≠ficas. O que o Socket.io faz √© dar a liberdade de definir quaisquer eventos desejados.

% Essa cria√ß√£o de eventos funciona assim: na hora de enviar uma mensagem, o processo emissor define tamb√©m o nome do evento que est√° sendo enviado. O processo receptor define o evento que vai ouvir e a subrotina que vai ser executada na ocorr√™ncia desse evento.

% Um ponto negativo dessa defini√ß√£o de eventos √© que o cabe√ßalho da mensagem √© um pouco maior, pois o de WebSockets √© m√≠nimo ao extremo, mas esse tamanho ainda √© √≠nfimo e o overhead causado √© desprez√≠vel.

% Essas funcionalidades aumentam muito o grau de liberdade e permitem um escopo muito maior na hora de criar uma aplica√ß√£o robusta. Imagine um sistema grande, onde dados s√£o recebidos de m√∫ltiplas fontes, c√°lculos s√£o feitos sobre eles, e o resultado pode ativar v√°rios comportamentos de um outro processo. Algo assim exigiria um c√≥digo complexo com WebSockets, mas com Socket.io √© simples e direto.


Abaixo, √© exibido o c√≥digo de um chat simples como exemplo. O c√≥digo est√° completo, nada foi omitido para explicitar a simplicidade de se fazer uma aplica√ß√£o com Socket.io.

% http://socket.io/get-started/chat/

No cliente:
%(TODO defini√ß√£o de sintaxe?)
\begin{small}
\begin{Verbatim}[frame=single]
<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
      form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
      form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) { background: #eee; }
    </style>
  </head>
  <body>
    <ul id="messages"></ul>
    <form action="">
      <input id="m" autocomplete="off" /><button>Send</button>
    </form>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      var socket = io();
      $('form').submit(function(){
        socket.emit('chat message', $('#m').val());
        $('#m').val('');
        return false;
      });
      socket.on('chat message', function(msg){
        $('#messages').append($('<li>').text(msg));
      });
    </script>
  </body>
</html>
\end{Verbatim}
\end{small}

%(TODO formata√ß√£o)
- No browser, a p√°gina HTML exibe o hist√≥rico da conversa e um formul√°rio para o usu√°rio escrever uma mensagem.

- Ao inserir uma mensagem, o socket envia um evento 'chat message' com a texto.

- O socket ouve um evento com o mesmo nome 'chat message'. Ao ocorrer, o conte√∫do recebido √© inserido na p√°gina e exibido ao usu√°rio.

- Note que n√£o h√° um evento 'connection' definido, mas ainda assim ele √© disparado quando a conex√£o √© definida, e envia seus dados de identifica√ß√£o.


No servidor:

\begin{small}
\begin{Verbatim}[frame=single]
var app = require('express')();
var http = require('http').Server(app);
var io = require('socket.io')(http);

app.get('/', function(req, res){
  res.sendFile(__dirname + '/index.html');
});

io.on('connection', function(socket){
  socket.on('chat message', function(msg){
    io.emit('chat message', msg);
  });
});

http.listen(3000, function(){
  console.log('listening on *:3000');
});
\end{Verbatim}
\end{small}

%(TODO formata√ß√£o)
- No servidor, o evento 'connection' ativa uma subrotina que recebe o socket e registra nele o evento 'chat message'.

- O evento 'chat message' ativa uma subrotina que emite a mensagem recebida para todos os sockets conectados ao servidor.

Esse exemplo mostra m√∫ltiplos sockets em uso no servidor, e a defini√ß√£o de eventos arbitr√°rios, ainda que semelhantes aos de WebSocket.

Por fim, √© poss√≠vel dizer que resolve os problemas apresentados. Ele torna poss√≠vel a comunica√ß√£o bilateral cliente-servidor com m√≠nimo custo e baixa lat√™ncia. Sua interface simples torna o desenvolvimento de aplica√ß√µes Web r√°pido e direto, mas suas funcionalidades s√£o poderosas o bastante para se criar algo consistente, robusto e, principalmente, escal√°vel.

Socket.io √© a principal ferramenta usada para fazer esse Projeto funcionar.

\newpage

\section{Evolu√ß√£o do Projeto}

Esse projeto utiliza v√°rias tecnologias que eu nunca tive contato.


Inicialmente a ideia inicial do TCC era usar um Arduino e um conjunto de sensores para coletar dados do meio e mandar de maneira s√≠ncrona para um servidor. O servidor ent√£o usaria esses dados para fazer algum controle. Numa primeira discuss√£o com o orientador, a ideia foi rapidamente descartada, pelos seguintes motivos:

Os sensores dele normalmente s√£o imprecisos;
A montagem de um dispositivo como o idealizado seria desnecessariamente custosa e muito propensa a erros;
Sem uma montagem muito bem executada, o dispositivo ficaria muito fr√°gil;
√â poss√≠vel conseguir muitas leituras de sensores utilizando um smartphone.


Com os argumentos apresentados, a decis√£o foi criar um aplicativo para Android com o mesmo prop√≥sito. Todos os argumentos apresentados s√£o resolvidos com essa solu√ß√£o. A implementa√ß√£o √© extremamente mais simples; os sensores s√£o muito mais precisos; a estrutura f√≠sica j√° est√° pronta e √© um objeto que j√° est√° presente em todo o mundo (o produto final atinge grande parte da popula√ß√£o); e, por fim, √© muito vi√°vel a adi√ß√£o ou remo√ß√£o de funcionalidades, al√©m de muito mais suporte para a plataforma.


Uma vez que a decis√£o de utilizar um smartphone, foi necess√°rio saber como implementar um aplicativo que tenha acesso aos sensores.
A primeira ideia foi utilizar servi√ßo MIT App Inventor.





\section{Tecnologias citadas}





\subsection{MIT App Inventor}

√â um servi√ßo disponibilizado pelo MIT para a cria√ß√£o de aplicativos. Ele √© extremamente did√°tico e inclusivo, sua interface n√£o √© dada por linhas de c√≥digo, e sim por blocos l√≥gicos que se encaixam e formam um algoritmo (na pr√°tica, √© bastante ruim n√£o poder escrever linhas de c√≥digo livremente). Sua API possui interface para o uso de sensores, al√©m de outras funcionalidades que n√£o foram exploradas neste TCC, como acesso √† ferramenta de reconhecimento de voz e ferramentas sociais, como email, mensagem e Twitter. O servi√ßo √© bom, por√©m possui v√°rias restri√ß√µes, ent√£o √© dif√≠cil de ser usado.


Com certa dificuldade um primeiro aplicativo de teste foi feito, para pegar valores do girosc√≥pio. O pr√≥ximo passo seria criar um servidor e estabelecer uma conex√£o entre ambos, por√©m as op√ß√µes de conectividade do App Inventor tamb√©m s√£o muito restritas, ent√£o, dada a dificuldade prevista, eu achei melhor deixar essa plataforma de lado no momento e procurar outras alternativas para a cria√ß√£o de um app.


\subsection{Kivy}

√â um framework Open Source de Python. Seu objetivo √© o desenvolvimento r√°pido de aplica√ß√µes multiplataforma que fazem o uso de interfaces inovadoras, como telas com Multitouch e sensores de movimento. Sua API, por exemplo, lida com eventos de mouse, teclado e toques de tela. Ele tamb√©m possui um foco na cria√ß√£o de apps com NUI (Natural User Interface).
  NUI √© uma metodologia de interface cuja proposta √© ser invis√≠vel ao usu√°rio, e apresentar uma experi√™ncia natural e intuitiva. Seu principal foco √© evitar grandes barreiras durante o aprendizado. Atrav√©s de decis√µes de design, o usu√°rio tem um entendimento do software sem grandes dificuldades, √† medida que a complexidade da intera√ß√£o aumenta.

[TODO] Para exemplificar a facilidade de desenvolvimento de l√≥gica e de uma interface gr√°fica, abaixo tem o c√≥digo para se criar um jogo de Pong.



\section{Parte Subjetiva}


\subsection{Desafios e frustra√ß√µes}
\subsection{A contribui√ß√£o do curso de Computa√ß√£o}
\subsection{Pr√≥ximo Passos}
\subsection{Agradecimentos}




% TODO Apendice: falar do SPDY (protocolo tipo http)


\section{Bibliografia}

% Bibliografia:
% https://en.wikipedia.org/wiki/Kivy
% https://en.wikipedia.org/wiki/Natural_user_interface


% Imagens:



% Ajax
% https://en.wikipedia.org/wiki/Ajax_(programming)

% Imagens de conex√£o cliente servidor com Sockets
% https://docs.oracle.com/javase/tutorial/networking/sockets/definition.html



% BIBLIOGRAFIA
% https://www.websocket.org/quantum.html


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 \singlespacing   % espa√ßamento simples
\bibliographystyle{unsrt}
 % cita√ß√£o bibliogr√°fica textual
 \bibliography{referencias}  % associado ao arquivo: 'referencias.bib'

\end{document}
